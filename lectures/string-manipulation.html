<!DOCTYPE html>
<html>
    <head>
    <title>String Manipulation &middot; Reproducible Research.</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="http://eriqande.github.io/rep-res-web/www/bootstrap.min.css" rel="stylesheet">
    <link href="http://eriqande.github.io/rep-res-web/www/highlight.css" rel="stylesheet">

    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700'
      rel='stylesheet' type='text/css'>
  </head>

  <body>
    <div class="navbar navbar-default navbar-static-top">
 <div class="navbar-header"><a class="navbar-brand" href="http://eriqande.github.io/rep-res-web">RepResCourse</a>
      <a class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="http://eriqande.github.io/rep-res-web/syllabus.html">Syllabus</a></li>
        <li><a href="http://eriqande.github.io/rep-res-web/resources.html">Resources</a></li>
        <li><a href="http://eriqande.github.io/rep-res-web/blogs.html">Instructor Blog</a></li>
        <li><a href="#">Results/Gallery</a></li>
      </ul>
      <div class="navbar-right">
    	<p class="navbar-text">I'm navbar-fixed-top</p>
  	  </div>
    </div>
</div>


    <div class="container">
            <!-- The title and stuff is here -->
      <div class="masthead">
        <p> </p>
        <p> </p>
        <h3 class="muted"><a href="http://eriqande.github.io/rep-res-web/">Reproducible Research Course</a> <small>by Eric C. Anderson for (NOAA/SWFSC)</small></h3>
        <hr>
      </div>

      <div class="row">
        <div class="col-sm-3" id="nav">
          <div class="well">
  How's this site built? See all sources at the course <a href="http://github.com/eriqande/rep-res-course">repository</a> on GitHub.
  <p><hr></p>
  <p><a class="btn btn-primary" href="https://raw.githubusercontent.com/eriqande/rep-res-course/master/lectures/string-manipulation.rmd">Raw on GitHub</a></p>
</div>

<h4>Page Contents</h4>
<ul class="list-unstyled" id="toc"></ul>

<hr>
<p><a href="http://eriqande.github.io/rep-res-web/contribute.html">How to contribute</a></p>
<p><a class="btn btn-primary" href="https://github.com/eriqande/rep-res-course/edit/master/lectures/string-manipulation.rmd">Edit this page</a></p>


        </div>

        <div id="content" class="col-sm-8 pull-right">
          <h1 id="string-manipulation">String manipulation with R</h1>
<h2 id="string-manipulation-intro">Intro</h2>
<p>R comes with some fairly well-developed tools for string manipulation and the application of <em>regular expressions</em>. If you are a fan of Perl or Python, or you have a penchant for Unix utilities like <em>sed</em> and <em>awk</em>, then you might find that you prefer those languages/workflows for doing your text processing. However, you can do quite a lot with R, and if all of your other analyses are done in R, there is some advantage to also doing your text processing within R.</p>
<p>If you are not yet familiar with any other text-processing systems and R is your first real programming language, then you might as well learn string manipulation in R!</p>
<p>If you are used to a “line-by-line” loop-based processing paradigm like that used in <em>awk</em>, then R’s focus on vectors of strings can take some getting used to. However, once you get comfortable with it and the sorts of operations that are useful within that framework, it can be quite powerful.</p>
<p>The base R package comes with a full set of string manipulation functions that are quite versatile. However, they don’t have consistent interfaces and they come with a lot of options that most people will never need to learn. So, while we are learning this stuff, we will focus on using the functions in Hadley Wickham’s package <code>stringr</code> which preserves about 95% of the functionality of the base R string functions, but don’t carry around a lot of extra function-parameter shrubbery that will trip up a lot of users. For a quick intro to <code>stringr</code> check out <a href="http://journal.r-project.org/archive/2010-2/RJournal_2010-2_Wickham.pdf">this</a></p>
<p>To illustrate these ideas we will use a real example from my own work: processing a text file containing data specifications for the coded wire tag data base.</p>
<h3 id="string-manip-prereq">Prerequisites</h3>
<ul>
<li>To work through the examples you will the <code>stringr</code> package.</li>
<li>Please download/install this before coming to class:
<ol style="list-style-type: decimal">
<li><p>install necessary packages:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="kw">c</span>(<span class="st">&quot;stringr&quot;</span>, <span class="st">&quot;zoo&quot;</span>))</code></pre></li>
<li><p>Pull the most recent version of the rep-res-course repo just before coming to class.</p></li>
</ol></li>
</ul>
<h3>Goals for this hour:</h3>
<ul>
<li>Present example text-processing problem</li>
<li>Briefly cover the idea of <em>regular expressions</em></li>
<li>Show how to use functions in <code>stringr</code> to solve the problem</li>
</ul>
<h2 id="rmis-example-problem">Example problem</h2>
<h3>RMIS</h3>
<ul>
<li>The Regional Mark Processing Center (RMPC) maintains data bases having to do with catch, sampling, release and recovery of salmon and coded wire tags. These data bases are known collectively as the Regional Mark Information System (RMIS).</li>
<li>You can query the data bases and get information from <a href="http://www.rmpc.org" class="uri">http://www.rmpc.org</a></li>
<li>Many of the fields in the data base use codes to denote certain values. For example, in the <em>species</em> column in each data base, a 1 = Chinook salmon and a 2 = Coho, a 3 = Steelhead, etc.<br /></li>
<li>If you are going to be analyzing these data in R, or plotting them, or just looking at them, it might be nice to recode such columns as <em>factors</em> with levels that are the actual species names. (This beats trying to remember all sorts of codes).</li>
</ul>
<h3>The PSC data specification</h3>
<ul>
<li>First, the good news:
<ul>
<li>A comprehensive list of codes and values is available at <a href="http://www.rmpc.org/files/PSC_V41_Specification.pdf" class="uri">http://www.rmpc.org/files/PSC_V41_Specification.pdf</a></li>
</ul></li>
<li>Now the bad news:
<ul>
<li>The RMPC does not maintain a listing of these codes in an easily parseable (i.e. reproducible!) format.<br /></li>
<li>This means that you have to extract all the codes from a PDF file, which is a rather ugly proposition.</li>
</ul></li>
<li>The folks who run the RMPC are pretty cool, though, and were able to supply me with a Microsoft Word document from whence the PDF file was created.<br /></li>
<li>MS Word, as we’ve all learned in this course is not a reproducible or easily-parseable format, but we are going to do our best with it.</li>
</ul>
<h3>PSC Spec in text</h3>
<ul>
<li>I was able to copy and paste the specification, make sure it had Unix, instead of Mac line endings, and save it.</li>
<li>A copy is in the course repo at: <code>data/PSC-Specification-ver-4.1_7-1-14.txt</code></li>
<li>Go ahead and have a look at it in a suitably good text editor. If you are using TextWrangler on your Mac then you can have it View -&gt; Text Display -&gt; Show Invisibles to see what are tabs and what are spaces, etc.</li>
<li>Here is a little section of the 2,855 lines in the file:</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">CHAPTER <span class="dv">2</span>
Release Data

PSC   PSC Common Name   Max Reqd    Format /Use Description &amp;<span class="st"> </span>Validation Rules.......................................................................................................................................
Fld <span class="co">#   and Data Field Name Cols            </span>
<span class="dv">1</span>   Record Code <span class="dv">1</span>   Yes Lookup  Code to indicate the CWT data file <span class="kw">classification</span> (class) of this individual record.  Must match one of the following:
<span class="st">    </span>record_code         ’T’ =Tagged Release record
                ’N’ =Non-Associated Release record
                    See chapter <span class="dv">16</span> for further discussion of the use of this field.
                    
<span class="dv">2</span>   Format Version  <span class="dv">4</span>   Yes ’<span class="fl">4.1</span>’   Format version used to report data
    format_version              Must have the value:<span class="st">   </span>’<span class="fl">4.1</span>’
                    
<span class="dv">3</span>   Submission Date <span class="dv">8</span>   Yes YYYYMMDD    Date of submission for this set of records.  Date should be close to actual date when this row is sent to the Mark Center
    submission_date             Must have the same value for all records in this data submission
                    Should match submission_date in corresponding Description file
                    
<span class="dv">4</span>   Reporting Agency    <span class="dv">10</span>  Yes Lookup  Abbreviation for reporting agency of this dataset for this data exchange
    reporting_agency                Must contain an agency code defined in chapter <span class="dv">8</span>
                    Must be the same for all records
                    
<span class="dv">5</span>   Release Agency  <span class="dv">10</span>  Yes Lookup  Abbreviations for tagging agencies
    release_agency              Must contain an agency code defined in chapter <span class="dv">8</span>
                    
<span class="dv">6</span>   Coordinator <span class="dv">2</span>   Yes Lookup  Reporting coordinator for the release group of this individual record
    coordinator             Must match one of the following:
<span class="st">                </span>’<span class="dv">01</span>’    =<span class="kw">ADFG</span> (S.E. Alaska)
                ’<span class="dv">02</span>’    =NMFS – Alaska
                ’<span class="dv">03</span>’    =CDFO
                ’<span class="dv">04</span>’    =WDFW
                ’<span class="dv">05</span>’    =ODFW
                ’<span class="dv">06</span>’    =NMFS – Columbia River
                ’<span class="dv">07</span>’    =USFWS
                ’<span class="dv">08</span>’    =CDFG
                ’<span class="dv">09</span>’    =BCFW
                ’<span class="dv">10</span>’    =IDFG
                ’<span class="dv">11</span>’    =YAKA
                ’<span class="dv">12</span>’    =<span class="kw">ADFG</span> (S. Central AK)
                ’<span class="dv">13</span>’    =<span class="kw">MIC</span> (Metlakatla, AK)
                ’<span class="dv">14</span>’    =NWIFC
                ’<span class="dv">15</span>’    =CRITFC
                ‘<span class="dv">16</span>’              =NEZP
                ‘<span class="dv">17</span>’              =QDNR
                ‘<span class="dv">18</span>’              =STIL             </code></pre>
<ul>
<li>What a freakshow! I can’t believe that we have to do this! (But on the other hand it is kind of fun…)</li>
</ul>
<h3>A closer look at the format</h3>
<ul>
<li><p>The specification is organized into a series of chapters that start with lines that look like:</p>
<pre class="sourceCode r"><code class="sourceCode r">CHAPTER <span class="dv">2</span></code></pre>
<p>Chapters 2 through 6 have information about the five data bases I’ll be working with:</p>
<pre class="sourceCode r"><code class="sourceCode r">Chapter <span class="dv">2</span> – Release Data
Chapter <span class="dv">3</span> – Recovery Data
Chapter <span class="dv">4</span> – Catch/Sample Data
Chapter <span class="dv">5</span> – Catch &amp;<span class="st"> </span>Effort Data
Chapter <span class="dv">6</span> – Location Data</code></pre></li>
<li><p>Within every chapter there are multiple entries that give the names of the fields (columns). For example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">4</span>   Reporting Agency    <span class="dv">10</span>  Yes Lookup  Abbreviation for reporting agency of this dataset for this data exchange
    reporting_agency                Must contain an agency code defined in chapter <span class="dv">8</span>
                Must be the same for all records

<span class="dv">5</span>   Release Agency  <span class="dv">10</span>  Yes Lookup  Abbreviations for tagging agencies
    release_agency              Must contain an agency code defined in chapter <span class="dv">8</span></code></pre>
Shows that field 4 is <code>reporting_agency</code>, etc.</li>
<li><p>Some of the fields have lists of codes that look like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">6</span>  Coordinator  <span class="dv">2</span>   Yes Lookup  Reporting coordinator for the release group of this individual record
          coordinator               Must match one of the following:
<span class="st">                </span>’<span class="dv">01</span>’    =<span class="kw">ADFG</span> (S.E. Alaska)
                ’<span class="dv">02</span>’    =NMFS – Alaska
                ’<span class="dv">03</span>’    =CDFO
                ’<span class="dv">04</span>’    =WDFW
                ’<span class="dv">05</span>’    =ODFW
                ’<span class="dv">06</span>’    =NMFS – Columbia River
                ’<span class="dv">07</span>’    =USFWS
                ’<span class="dv">08</span>’    =CDFG
                ’<span class="dv">09</span>’    =BCFW
                ’<span class="dv">10</span>’    =IDFG
                ’<span class="dv">11</span>’    =YAKA
                ’<span class="dv">12</span>’    =<span class="kw">ADFG</span> (S. Central AK)
                ’<span class="dv">13</span>’    =<span class="kw">MIC</span> (Metlakatla, AK)
                ’<span class="dv">14</span>’    =NWIFC
                ’<span class="dv">15</span>’    =CRITFC
                ‘<span class="dv">16</span>’              =NEZP
                ‘<span class="dv">17</span>’              =QDNR
                ‘<span class="dv">18</span>’              =STIL             </code></pre>
<p>These codes take the form of string (usually a single character or a number) that is quoted in some special quotes that are sometimes upside down and sometimes right side up; then a TAB, then an equals sign followed by another string with no space.</p></li>
</ul>
<h3>Our mission</h3>
<ul>
<li>For every field (in each of the five data bases) that has specialized codes, we want to know what the codes are and what they means.</li>
<li>In the end we will want to have a tidy data frame of these that looks something like this:</li>
</ul>
<table>
<thead>
<tr class="header">
<th align="left">chapter</th>
<th align="left">field</th>
<th align="left">code</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">“01”</td>
<td align="left">ADFG (S.E. Alaska)</td>
</tr>
<tr class="even">
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">“02”</td>
<td align="left">NMFS – Alaska</td>
</tr>
<tr class="odd">
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">“03”</td>
<td align="left">CDFO</td>
</tr>
<tr class="even">
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">“04”</td>
<td align="left">WDFW</td>
</tr>
</tbody>
</table>
<ul>
<li>If we wanted to be old school about it we could just spend two weeks copying and pasting everything, and hope that the spec doesn’t change any time soon, because we wouldn’t want to waste a full two weeks doing that again (even if our wrists were not totally trashed after that.)</li>
<li>But we are going to try to automate this.</li>
</ul>
<h2 id="reg-exp">Regular expressions</h2>
<p>Before we can get rolling on this we are going to have to cover some <em>regular expressions</em>.</p>
<h3>What is a regular expression?</h3>
<ul>
<li>You can think of a regular expression as a “fuzzy find” pattern that let’s you match text strings while including “wildcards” and “character classes”, and maybe even capturing text that matches in certain ways to your pattern.</li>
<li>Here is a simple example.</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)  <span class="co"># load the package</span>

<span class="co"># now make a character vector</span>
vec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fred&quot;</span>, <span class="st">&quot;foo&quot;</span>, <span class="st">&quot;food&quot;</span>, <span class="st">&quot;bed&quot;</span>, <span class="st">&quot;reefed&quot;</span>)

<span class="co"># see if any matches &quot;fred&quot;</span>
<span class="kw">str_detect</span>(vec, <span class="st">&quot;fred&quot;</span>)
<span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE FALSE</span>

<span class="co"># see if any have an &quot;f&quot; followed by a &quot;d&quot;</span>
<span class="co"># after 0 or more other characters</span>
<span class="kw">str_detect</span>(vec, <span class="st">&quot;f.*d&quot;</span>)
<span class="co">#&gt; [1]  TRUE FALSE  TRUE FALSE  TRUE</span>

<span class="co"># see if any start with an &quot;f&quot;</span>
<span class="kw">str_detect</span>(vec, <span class="st">&quot;^f&quot;</span>)
<span class="co">#&gt; [1]  TRUE  TRUE  TRUE FALSE FALSE</span>

<span class="co"># see if any end with an &quot;o&quot;</span>
<span class="kw">str_detect</span>(vec, <span class="st">&quot;o$&quot;</span>)
<span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE FALSE</span></code></pre>
<h3>Holy cow! That looks funky</h3>
<ul>
<li>Yes, there is a whole pantheon of regular expression “metacharacters” that you will want to get familiar with.<br /></li>
<li>Entire books have been written on regular expressions, so I won’t attempt to teach you all of it now, but I will point out some things that you will want to know.</li>
</ul>
<ol style="list-style-type: decimal">
<li>The simplest pattern is a single character. So, a regular expression of “<code>a</code>”&quot; says, match anything with an “<code>a</code>”&quot; in it.<br /></li>
<li>You can do things like specify how many times a pattern must occur to be considered a match. For example maybe you had strings of DNA and you wanted to detect runs of 7 “A”’s in a row in it. The regular expression that matched that would be <code>&quot;A{7}&quot;</code>.</li>
<li>A pattern can be a wildcard character which can take many different forms like:
<ul>
<li><code>.</code> = anything</li>
<li><code>[a-z]</code> a <em>character class</em> consisting of all lowercase letters</li>
<li><code>[[:lower:]]</code> another way of specifying the same thing as <code>[a-z]</code> that responds to locality.</li>
</ul></li>
<li>You can group patterns together by wrapping them in <code>(</code> and <code>)</code>. Then you can treat those things as patterns that must occur a certain number of times to be considered a match, etc.</li>
</ol>
<p>We will see examples of these things as we solve our problem at hand. For now, just know that you can build up regular expressions to search for very complex patterns in strings using this regex syntax that can seem quite baffling or even daunting at first.</p>
<p>For now, here are some important things to know</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># special meaning is given to these characters:</span>
. \ |<span class="st"> </span>( ) [ ] { } ^<span class="st"> </span><span class="er">$</span><span class="st"> </span><span class="er">*</span><span class="st"> </span>+<span class="st"> </span>?

.  <span class="co"># the dot matches any character (or number or punctuation, etc)</span>

\  <span class="co"># backslash is often used to &quot;escape&quot; metacharacters (and in R that could mean two backslashes)</span>

( )  <span class="co"># these guys are used to group patterns and also</span>
     <span class="co"># to capture the parts of a string that match grouped subpatterns</span>

[ ]  <span class="co"># you can specify character classes (like &quot;any lower case letter&quot; inside these)</span>

?    <span class="co"># The preceding item is optional and will be matched at most once.</span>

*<span class="st">    </span><span class="co"># The preceding item will be matched zero or more times.</span>
<span class="st">  </span>
+<span class="st">    </span><span class="co"># The preceding item will be matched one or more times.</span>
<span class="st">  </span>
{n}  <span class="co"># The preceding item is matched exactly n times.</span>

{n,} <span class="co"># The preceding item is matched n or more times.</span>

{n,m} <span class="co"># The preceding item is matched at least n times, but not more than m times.</span></code></pre>
<p>For a more complete description do <code>?regex</code> and see the “Extended Regular Expressions” section.</p>
<h2 id="getting-to-business">Getting down to business</h2>
<p>Quick note on <code>stringr</code> functions. Most of them have the syntax of:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str_something</span>( string,  pattern )</code></pre>
<p>where <em>something</em> is like “detect” or “match” or “replace”, and <em>pattern</em> is a regular expression passed in as a quoted string (or even a character <em>vector</em> in some cases)</p>
<h3>Step 1: read the strings in!</h3>
<p>The delightful <code>readLines()</code> function will let us read each line of <code>PSC-Specification-ver-4.1_7-1-14.txt</code> into a character vector:</p>
<pre class="sourceCode r"><code class="sourceCode r">spec &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;data/PSC-Specification-ver-4.1_7-1-14.txt&quot;</span>)
<span class="kw">length</span>(spec)
<span class="co">#&gt; [1] 2855</span>
<span class="kw">head</span>(spec)
<span class="co">#&gt; [1] &quot;&quot;                                                                                                 </span>
<span class="co">#&gt; [2] &quot;CHAPTER 1&quot;                                                                                        </span>
<span class="co">#&gt; [3] &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;                                                             </span>
<span class="co">#&gt; [4] &quot;&quot;                                                                                                 </span>
<span class="co">#&gt; [5] &quot;CWT data must be exchanged in the form of a PSC Format Version 4.1 dataset.&quot;                      </span>
<span class="co">#&gt; [6] &quot;The definition and specification of PSC Format Version 4.1 is described in this set of documents.&quot;</span></code></pre>
<h3>Step 2: figure out which chapter we are in</h3>
<p>Here is what our strategy is going to be for dealing with this</p>
<ol style="list-style-type: decimal">
<li>Start with a vector of NA’s of length(spec)</li>
<li>Put values in where each “CHAPTER” is found</li>
<li>Propagate those values forward, overwriting any NAs with the value that came before.</li>
</ol>
<p>In this way we get a vector, of, for example, what chapter we are in.</p>
<p>Let’s do it for the chapter names:</p>
<pre class="sourceCode r"><code class="sourceCode r">chapter &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">length</span>(spec))  <span class="co"># make a vector of NAs</span>
chap_positions &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">str_detect</span>(spec, <span class="st">&quot;^CHAPTER&quot;</span>))

<span class="co"># see what that looks like:</span>
chap_positions
<span class="co">#&gt;  [1]    2  159  492  835 1132 1280 1406 1466 1666 2009 2094 2189 2262 2589</span>
<span class="co">#&gt; [15] 2698 2775</span>

<span class="co"># now, the titles of the chapters are on the line following &quot;^CHAPTER&quot;</span>
<span class="co"># so let&#39;s get those and put them in and then roll them forward</span>
chapter[chap_positions] &lt;-<span class="st"> </span>spec[chap_positions +<span class="st"> </span><span class="dv">1</span>]
chapter_names &lt;-<span class="st"> </span><span class="kw">na.locf</span>(chapter, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>) <span class="co"># from the zoo package.  It rolls the last value forward over NAs</span>

<span class="co"># if you are following along, do this to see what we have done:</span>
<span class="co">#   cbind(chapter_names)</span></code></pre>
<h3>Step 2.5: Let’s get the chapter numbers while we are at it</h3>
<p>Now, we want to extract the number of each chapter. We can use a regular expression that finds strings in <code>spec</code> that</p>
<ol style="list-style-type: decimal">
<li>first have to match “^CHAPTER”</li>
<li>but then also have at least one space</li>
<li>and then one or more digits</li>
</ol>
<p><strong>AND</strong> we can use the <code>str_match</code> function to pull out the part that matches the 3rd part of the expression (i.e. the one or more digits). Check out <code>?str_match</code></p>
<p>Here we go!</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grab them</span>
chap_nums &lt;-<span class="st"> </span><span class="kw">str_match</span>(spec, <span class="st">&quot;^CHAPTER +([[:digit:]]+)&quot;</span>)

<span class="co"># notice that we have wrapped the part that matches one or more digits in parentheses!</span>

<span class="co"># note that str_match returns a matrix:</span>
<span class="kw">head</span>(chap_nums)
<span class="co">#&gt;      [,1]        [,2]</span>
<span class="co">#&gt; [1,] NA          NA  </span>
<span class="co">#&gt; [2,] &quot;CHAPTER 1&quot; &quot;1&quot; </span>
<span class="co">#&gt; [3,] NA          NA  </span>
<span class="co">#&gt; [4,] NA          NA  </span>
<span class="co">#&gt; [5,] NA          NA  </span>
<span class="co">#&gt; [6,] NA          NA</span>

<span class="co"># roll them forward</span>
chapter_numbers &lt;-<span class="st"> </span><span class="kw">na.locf</span>(chap_nums[,<span class="dv">2</span>], <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)

<span class="co"># see what we have done so far looks like</span>
<span class="kw">head</span>(<span class="kw">cbind</span>(chapter_numbers, chapter_names))
<span class="co">#&gt;      chapter_numbers chapter_names                         </span>
<span class="co">#&gt; [1,] NA              NA                                    </span>
<span class="co">#&gt; [2,] &quot;1&quot;             &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;</span>
<span class="co">#&gt; [3,] &quot;1&quot;             &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;</span>
<span class="co">#&gt; [4,] &quot;1&quot;             &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;</span>
<span class="co">#&gt; [5,] &quot;1&quot;             &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;</span>
<span class="co">#&gt; [6,] &quot;1&quot;             &quot;INTRODUCTION, DEFINITIONS, AND RULES&quot;</span></code></pre>
<h3>Step 3: Figure out which field each line of the file is in</h3>
<p>Our main concern is going to be extracting codes that have to do with fields that we can identify according to which chapter they are in (which corresponds to the data base) and then which field name we are in.</p>
<p>Happily, it is easy to find the beginnings of field heading sections. They are the only lines in the file I see that start with one or two digits, followed immediately by a TAB. (At least that is the case for the five chapters we are interested in.)</p>
<p>Recall that these things look like:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">2</span>  Format Version   <span class="dv">4</span>   Yes ’<span class="fl">4.1</span>’   Format version used to report data
    format_version              Must have the value:<span class="st">   </span>’<span class="fl">4.1</span>’
                    
<span class="dv">3</span>   Submission Date <span class="dv">8</span>   Yes YYYYMMDD    Date of submission for this set of records.  Date should be close to actual date when this row is sent to the Mark Center
    submission_date             Must have the same value for all records in this data submission
                    Should match submission_date in corresponding Description file</code></pre>
<p>So, we are going to get those positions, and then try to extract the field names, which appear on the following lines, stuck between TABS:</p>
<pre class="sourceCode r"><code class="sourceCode r">field_starts &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">str_detect</span>(spec, <span class="st">&quot;^[[:digit:]]{1,2}</span><span class="ch">\t</span><span class="st">&quot;</span>))
field_names &lt;-<span class="st"> </span><span class="kw">str_match</span>(spec[field_starts +<span class="st"> </span><span class="dv">1</span>], <span class="st">&quot;^</span><span class="ch">\t</span><span class="st">([_[:alnum:]]+)</span><span class="ch">\t</span><span class="st">&quot;</span>)
field_names[,<span class="dv">2</span>]
<span class="co">#&gt;   [1] &quot;record_code&quot;               &quot;format_version&quot;           </span>
<span class="co">#&gt;   [3] &quot;submission_date&quot;           &quot;reporting_agency&quot;         </span>
<span class="co">#&gt;   [5] &quot;release_agency&quot;            &quot;coordinator&quot;              </span>
<span class="co">#&gt;   [7] &quot;tag_code_or_release_id&quot;    &quot;tag_type&quot;                 </span>
<span class="co">#&gt;   [9] &quot;first_sequential_number&quot;   &quot;last_sequential_number&quot;   </span>
<span class="co">#&gt;  [11] &quot;related_group_type&quot;        &quot;related_group_id&quot;         </span>
<span class="co">#&gt;  [13] &quot;species&quot;                   &quot;run&quot;                      </span>
<span class="co">#&gt;  [15] &quot;brood_year&quot;                &quot;first_release_date&quot;       </span>
<span class="co">#&gt;  [17] &quot;last_release_date&quot;         &quot;release_location_code&quot;    </span>
<span class="co">#&gt;  [19] &quot;hatchery_location_code&quot;    &quot;stock_location_code&quot;      </span>
<span class="co">#&gt;  [21] &quot;release_stage&quot;             &quot;rearing_type&quot;             </span>
<span class="co">#&gt;  [23] &quot;study_type&quot;                &quot;release_strategy&quot;         </span>
<span class="co">#&gt;  [25] &quot;avg_weight&quot;                &quot;avg_length&quot;               </span>
<span class="co">#&gt;  [27] &quot;study_integrity&quot;           &quot;cwt_1st_mark&quot;             </span>
<span class="co">#&gt;  [29] &quot;cwt_1st_mark_count&quot;        &quot;cwt_2nd_mark&quot;             </span>
<span class="co">#&gt;  [31] &quot;cwt_2nd_mark_count&quot;        &quot;non_cwt_1st_mark&quot;         </span>
<span class="co">#&gt;  [33] &quot;non_cwt_1st_mark_count&quot;    &quot;non_cwt_2nd_mark&quot;         </span>
<span class="co">#&gt;  [35] &quot;non_cwt_2nd_mark_count&quot;    &quot;counting_method&quot;          </span>
<span class="co">#&gt;  [37] &quot;tag_loss_rate&quot;             &quot;tag_loss_days&quot;            </span>
<span class="co">#&gt;  [39] &quot;tag_loss_sample_size&quot;      &quot;tag_reused&quot;               </span>
<span class="co">#&gt;  [41] &quot;comments&quot;                  &quot;record_code&quot;              </span>
<span class="co">#&gt;  [43] &quot;format_version&quot;            &quot;submission_date&quot;          </span>
<span class="co">#&gt;  [45] &quot;reporting_agency&quot;          &quot;sampling_agency&quot;          </span>
<span class="co">#&gt;  [47] &quot;recovery_id&quot;               &quot;species&quot;                  </span>
<span class="co">#&gt;  [49] &quot;run_year&quot;                  &quot;recovery_date&quot;            </span>
<span class="co">#&gt;  [51] &quot;recovery_date_type&quot;        &quot;period_type&quot;              </span>
<span class="co">#&gt;  [53] &quot;period&quot;                    &quot;fishery&quot;                  </span>
<span class="co">#&gt;  [55] &quot;gear&quot;                      &quot;adclip_selective_fishery&quot; </span>
<span class="co">#&gt;  [57] &quot;estimation_level&quot;          &quot;recovery_location_code&quot;   </span>
<span class="co">#&gt;  [59] &quot;sampling_site&quot;             &quot;recorded_mark&quot;            </span>
<span class="co">#&gt;  [61] &quot;sex&quot;                       &quot;weight&quot;                   </span>
<span class="co">#&gt;  [63] &quot;weight_code&quot;               &quot;weight_type&quot;              </span>
<span class="co">#&gt;  [65] &quot;length&quot;                    &quot;length_code&quot;              </span>
<span class="co">#&gt;  [67] &quot;length_type&quot;               &quot;detection_method&quot;         </span>
<span class="co">#&gt;  [69] &quot;tag_status&quot;                &quot;tag_code&quot;                 </span>
<span class="co">#&gt;  [71] &quot;tag_type&quot;                  &quot;sequential_number&quot;        </span>
<span class="co">#&gt;  [73] &quot;Number&quot;                    &quot;sequential_row_number&quot;    </span>
<span class="co">#&gt;  [75] &quot;catch_sample_id&quot;           &quot;sample_type&quot;              </span>
<span class="co">#&gt;  [77] &quot;sampled_maturity&quot;          &quot;sampled_run&quot;              </span>
<span class="co">#&gt;  [79] &quot;sampled_length_range&quot;      &quot;sampled_sex&quot;              </span>
<span class="co">#&gt;  [81] &quot;sampled_mark&quot;              &quot;estimated_number&quot;         </span>
<span class="co">#&gt;  [83] &quot;record_code&quot;               &quot;format_version&quot;           </span>
<span class="co">#&gt;  [85] &quot;submission_date&quot;           &quot;reporting_agency&quot;         </span>
<span class="co">#&gt;  [87] &quot;sampling_agency&quot;           &quot;catch_sample_id&quot;          </span>
<span class="co">#&gt;  [89] &quot;species&quot;                   &quot;catch_year&quot;               </span>
<span class="co">#&gt;  [91] &quot;period_type&quot;               &quot;period&quot;                   </span>
<span class="co">#&gt;  [93] &quot;first_period&quot;              &quot;last_period&quot;              </span>
<span class="co">#&gt;  [95] &quot;fishery&quot;                   &quot;adclip_selective_fishery&quot; </span>
<span class="co">#&gt;  [97] &quot;estimation_level&quot;          NA                         </span>
<span class="co">#&gt;  [99] &quot;detection_method&quot;          &quot;sample_type&quot;              </span>
<span class="co">#&gt; [101] &quot;sampled_maturity&quot;          &quot;sampled_run&quot;              </span>
<span class="co">#&gt; [103] &quot;sampled_length_range&quot;      &quot;sampled_sex&quot;              </span>
<span class="co">#&gt; [105] &quot;sampled_mark&quot;              &quot;number_caught&quot;            </span>
<span class="co">#&gt; [107] NA                          &quot;number_sampled&quot;           </span>
<span class="co">#&gt; [109] &quot;number_estimated&quot;          &quot;number_recovered_decoded&quot; </span>
<span class="co">#&gt; [111] &quot;number_recovered_no_cwts&quot;  &quot;CWTs&quot;                     </span>
<span class="co">#&gt; [113] &quot;Unreadable&quot;                &quot;Unresolved&quot;               </span>
<span class="co">#&gt; [115] NA                          &quot;PseudoTags&quot;               </span>
<span class="co">#&gt; [117] &quot;mr_1st_partition_size&quot;     &quot;mr_1st_sample_size&quot;       </span>
<span class="co">#&gt; [119] NA                          &quot;mr_1st_sample_obs_adclips&quot;</span>
<span class="co">#&gt; [121] &quot;mr_2nd_partition_size&quot;     &quot;mr_2nd_sample_size&quot;       </span>
<span class="co">#&gt; [123] &quot;Status&quot;                    &quot;mr_2nd_sample_obs_adclips&quot;</span>
<span class="co">#&gt; [125] &quot;mark_rate&quot;                 &quot;awareness_factor&quot;         </span>
<span class="co">#&gt; [127] NA                          &quot;Adclips&quot;                  </span>
<span class="co">#&gt; [129] &quot;record_code&quot;               &quot;format_version&quot;           </span>
<span class="co">#&gt; [131] &quot;submission_date&quot;           &quot;reporting_agency&quot;         </span>
<span class="co">#&gt; [133] &quot;catch_effort_id&quot;           &quot;catch_year&quot;               </span>
<span class="co">#&gt; [135] &quot;period_type&quot;               &quot;period&quot;                   </span>
<span class="co">#&gt; [137] &quot;landing_status&quot;            &quot;catch_location_code&quot;      </span>
<span class="co">#&gt; [139] &quot;harvest&quot;                   &quot;fisher&quot;                   </span>
<span class="co">#&gt; [141] &quot;catch_gear_group&quot;          &quot;catch_gear&quot;               </span>
<span class="co">#&gt; [143] &quot;species&quot;                   &quot;grade&quot;                    </span>
<span class="co">#&gt; [145] &quot;number_tickets&quot;            &quot;catch_weight&quot;             </span>
<span class="co">#&gt; [147] &quot;number_caught&quot;             &quot;effort_type&quot;              </span>
<span class="co">#&gt; [149] &quot;effort_quantity&quot;           &quot;Adclip_selective_fishery&quot; </span>
<span class="co">#&gt; [151] &quot;record_code&quot;               &quot;format_version&quot;           </span>
<span class="co">#&gt; [153] &quot;submission_date&quot;           &quot;reporting_agency&quot;         </span>
<span class="co">#&gt; [155] &quot;location_code&quot;             &quot;name&quot;                     </span>
<span class="co">#&gt; [157] &quot;latitude&quot;                  &quot;longitude&quot;                </span>
<span class="co">#&gt; [159] &quot;psc_basin&quot;                 &quot;psc_region&quot;               </span>
<span class="co">#&gt; [161] &quot;description&quot;               &quot;record_code&quot;              </span>
<span class="co">#&gt; [163] &quot;format_version&quot;            &quot;submission_date&quot;          </span>
<span class="co">#&gt; [165] &quot;reporting_agency&quot;          &quot;submission_status&quot;        </span>
<span class="co">#&gt; [167] &quot;file_type&quot;                 &quot;file_status&quot;              </span>
<span class="co">#&gt; [169] &quot;first_year&quot;                &quot;last_year&quot;                </span>
<span class="co">#&gt; [171] &quot;description&quot;               NA                         </span>
<span class="co">#&gt; [173] NA                          NA                         </span>
<span class="co">#&gt; [175] NA                          NA                         </span>
<span class="co">#&gt; [177] NA                          NA                         </span>
<span class="co">#&gt; [179] NA                          NA                         </span>
<span class="co">#&gt; [181] NA                          NA                         </span>
<span class="co">#&gt; [183] NA                          NA                         </span>
<span class="co">#&gt; [185] NA                          NA                         </span>
<span class="co">#&gt; [187] NA                          NA                         </span>
<span class="co">#&gt; [189] NA                          NA                         </span>
<span class="co">#&gt; [191] NA                          NA                         </span>
<span class="co">#&gt; [193] NA                          NA                         </span>
<span class="co">#&gt; [195] NA                          NA                         </span>
<span class="co">#&gt; [197] NA                          NA                         </span>
<span class="co">#&gt; [199] NA                          NA                         </span>
<span class="co">#&gt; [201] NA                          NA                         </span>
<span class="co">#&gt; [203] NA                          NA                         </span>
<span class="co">#&gt; [205] NA                          NA                         </span>
<span class="co">#&gt; [207] NA                          NA                         </span>
<span class="co">#&gt; [209] NA                          NA                         </span>
<span class="co">#&gt; [211] NA                          NA                         </span>
<span class="co">#&gt; [213] NA                          NA                         </span>
<span class="co">#&gt; [215] NA                          NA                         </span>
<span class="co">#&gt; [217] NA                          NA                         </span>
<span class="co">#&gt; [219] NA                          NA                         </span>
<span class="co">#&gt; [221] NA                          NA                         </span>
<span class="co">#&gt; [223] NA                          NA                         </span>
<span class="co">#&gt; [225] NA                          NA</span></code></pre>
<p>Hmmm, some of these are not looking right. The NAs in the early numbers are not so good, and the ones with uppercase letters look wrong. Let’s get the line numbers and look at the original file:</p>
<pre class="sourceCode r"><code class="sourceCode r">linenos_to_investigate &lt;-<span class="st"> </span>field_starts[<span class="kw">which</span>(<span class="kw">is.na</span>(field_names[,<span class="dv">2</span>]) |<span class="st"> </span><span class="kw">str_detect</span>(field_names[,<span class="dv">2</span>], <span class="st">&quot;[[:upper:]]&quot;</span>))] +<span class="st"> </span><span class="dv">1</span> 
linenos_to_investigate
<span class="co">#&gt;  [1]  750  942 1009 1039 1043 1047 1051 1055 1069 1097 1122 1127 1267 1688</span>
<span class="co">#&gt; [15] 1689 1690 1736 1737 1738 1743 1744 1830 1831 1832 1833 1834 1835 2208</span>
<span class="co">#&gt; [29] 2209 2210 2211 2212 2216 2217 2218 2219 2224 2225 2226 2227 2231 2232</span>
<span class="co">#&gt; [43] 2233 2234 2238 2239 2240 2241 2242 2246 2247 2251 2252 2253 2254 2258</span>
<span class="co">#&gt; [57] 2259 2260 2261 2575 2576 2577 2758 2761 2763 2766 2769 2771</span></code></pre>
<p>When we take a look at all those linenumbers in the original file we see in one case a typo in the specification, and in a lot of other places you find the problem is due to lines being broken where they probably weren’t supposed to be, etc. In other words, the sort of inconsistent formatting that is probably an unavoidable consequence of trying to scrape <em>data</em> out of a medium (i.e. an MS Word doc) that is unsuited to actually storing data.</p>
<p>This mirrors one of the themes of this course that we’ve seen a few times: If your stuff is in a Word file or an Excel file, you should not expect your research to be reproducible.<br />It would be preferable if those PSC data specifications lived in their own SQL table within the RMIS data base.</p>
<p>But anyway, from the looks of it, we can safely ignore those inconsistent spots, because those fields don’t actually have codes that we are going to be scraping out in the next step.</p>
<p>So, now we have to put those <code>field_names</code> into a <code>fields</code> vector and roll them forward over the NAs:</p>
<pre class="sourceCode r"><code class="sourceCode r">fields_0 &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">length</span>(spec))
fields_0[field_starts] &lt;-<span class="st"> </span>field_names[,<span class="dv">2</span>]
fields &lt;-<span class="st"> </span><span class="kw">na.locf</span>(fields_0, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)</code></pre>
<p>Now, that this is done, let’s see what we are working on so far. We have something looking like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(<span class="kw">na.omit</span>(<span class="kw">data.frame</span>(chapter_numbers, chapter_names, fields, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)))
<span class="co">#&gt;     chapter_numbers chapter_names         fields</span>
<span class="co">#&gt; 164               2  Release Data    record_code</span>
<span class="co">#&gt; 165               2  Release Data    record_code</span>
<span class="co">#&gt; 166               2  Release Data    record_code</span>
<span class="co">#&gt; 167               2  Release Data    record_code</span>
<span class="co">#&gt; 168               2  Release Data    record_code</span>
<span class="co">#&gt; 169               2  Release Data format_version</span></code></pre>
<p>Rippin! That looks tidy!</p>
<h3>Step 4: Extract the codes and values</h3>
<p>Now we just have to extract the lines that have the code definitions on them!</p>
<p>When we find occurrences of these things, it always seems that they follow a pattern of:</p>
<pre class="sourceCode r"><code class="sourceCode r">TAB +<span class="st"> </span>Quote +<span class="st"> </span>AlphaNumericOrDash +<span class="st"> </span>Quote +<span class="st"> </span>TAB +<span class="st"> </span>EqualsSign +<span class="st"> </span>ValueWithNoSpaceAfterEqualsSign</code></pre>
<p>So, we can write a regex pattern for that. Some things must be noticed though:</p>
<ol style="list-style-type: decimal">
<li>The single quotes are not simple—they can be upside down or right side up and they are not consistent.</li>
<li>AlphaNumericOrDash is risky. Let’s start by matching one or more of anycharacter between those quotation marks.</li>
<li>All we can really do is plan to grab the value all the way out to the end of the line.</li>
<li>Sometimes they do have a space after the equals sign.</li>
</ol>
<p>Here is what our basic regex to capture each of those things looks like in the <code>str_detect</code> function:</p>
<pre class="sourceCode r"><code class="sourceCode r">gotem &lt;-<span class="st"> </span><span class="kw">str_detect</span>(spec, <span class="st">&quot;</span><span class="ch">\t</span><span class="st">[‘’].+[‘’]</span><span class="ch">\t</span><span class="st">=.*$&quot;</span>)

<span class="co"># note that the quotes might not look different in the font in the HTML.</span>
<span class="co"># see the actual code in RStudio to see what they look like.</span>

<span class="kw">sum</span>(gotem)  <span class="co"># how many lines of the spec match?</span>
<span class="co">#&gt; [1] 317</span>
<span class="kw">head</span>(spec[gotem])  <span class="co"># what do some of them look like?</span>
<span class="co">#&gt; [1] &quot;\trecord_code\t\t\t’T’\t=Tagged Release record&quot;</span>
<span class="co">#&gt; [2] &quot;\t\t\t\t’N’\t=Non-Associated Release record&quot;   </span>
<span class="co">#&gt; [3] &quot;\t\t\t\t’01’\t=ADFG (S.E. Alaska)&quot;             </span>
<span class="co">#&gt; [4] &quot;\t\t\t\t’02’\t=NMFS – Alaska&quot;                  </span>
<span class="co">#&gt; [5] &quot;\t\t\t\t’03’\t=CDFO&quot;                           </span>
<span class="co">#&gt; [6] &quot;\t\t\t\t’04’\t=WDFW&quot;</span></code></pre>
<p>That is all fine and well, but what we really want to do is capture particular parts of those lines that match certain subpatterns. So, prepare yourself for a parenthesis bonanza.</p>
<p>Recall that parentheses group patterns and we can extract the parts that match those sub-patterns explicitly with <code>str_match()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">codes_and_values &lt;-<span class="st"> </span><span class="kw">str_match</span>(spec, <span class="st">&quot;</span><span class="ch">\t</span><span class="st">[‘’](.+)[‘’]</span><span class="ch">\t</span><span class="st">=(.*)$&quot;</span>)</code></pre>
<p>The above grabs the “1 or more occurrences of any character” between the quotes and also all the characters after the equals sign. <code>str_match</code> returns a matrix. The first column is the whole match, and each successive column is a successive grouping (a different set of parentheses.)</p>
<p>If there isn’t a match then you get NAs.</p>
<h3>Step 5: Trim whitspace and bung these all into a data frame</h3>
<p>We now just need to stick these all into a data frame, but we will want to trim leading and trailing whitespace off of all of the codes and values in case someone left some in there… So we can use <code>str_trim()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">codes_and_values &lt;-<span class="st"> </span><span class="kw">str_trim</span>(codes_and_values)</code></pre>
<p>Then make that data frame</p>
<pre class="sourceCode r"><code class="sourceCode r">code_frame &lt;-<span class="st"> </span><span class="kw">data.frame</span>(chapter_numbers, 
                         chapter_names,
                         fields,
                         <span class="dt">codes =</span> codes_and_values[,<span class="dv">2</span>],
                         <span class="dt">values =</span> codes_and_values[,<span class="dv">3</span>],
                         <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</code></pre>
<p>Finally, remember that we only want to grab the codes for Chapters 2 through 6 inclusive. And, of course, we can drop any rows that have NAs since there were no codes or values on those lines. So</p>
<pre class="sourceCode r"><code class="sourceCode r">final_codes &lt;-<span class="st"> </span><span class="kw">na.omit</span>(<span class="kw">subset</span>(code_frame, chapter_numbers &gt;=<span class="st"> </span><span class="dv">2</span> &amp;<span class="st"> </span>chapter_numbers &lt;=<span class="st"> </span><span class="dv">6</span>))</code></pre>
<p>Phew! How does it look? Let’s look at the first 100 lines of it:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># i have to change some #&#39;s because the renderer confuses them with links</span>
<span class="kw">kable</span>(<span class="kw">str_replace_all</span>(<span class="dt">string =</span> <span class="kw">as.matrix</span>(final_codes[<span class="dv">1</span>:<span class="dv">100</span>,]), <span class="dt">pattern =</span> <span class="st">&quot;#&quot;</span>, <span class="st">&quot;--&quot;</span>), <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">chapter_numbers</th>
<th align="left">chapter_names</th>
<th align="left">fields</th>
<th align="left">codes</th>
<th align="left">values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">record_code</td>
<td align="left">T</td>
<td align="left">Tagged Release record</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">record_code</td>
<td align="left">N</td>
<td align="left">Non-Associated Release record</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">01</td>
<td align="left">ADFG (S.E. Alaska)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">02</td>
<td align="left">NMFS – Alaska</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">03</td>
<td align="left">CDFO</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">04</td>
<td align="left">WDFW</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">05</td>
<td align="left">ODFW</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">06</td>
<td align="left">NMFS – Columbia River</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">07</td>
<td align="left">USFWS</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">08</td>
<td align="left">CDFG</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">09</td>
<td align="left">BCFW</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">10</td>
<td align="left">IDFG</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">11</td>
<td align="left">YAKA</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">12</td>
<td align="left">ADFG (S. Central AK)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">13</td>
<td align="left">MIC (Metlakatla, AK)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">14</td>
<td align="left">NWIFC</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">coordinator</td>
<td align="left">15</td>
<td align="left">CRITFC</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">0</td>
<td align="left">Standard binary (1mm)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">1</td>
<td align="left">Half tags (H type)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">2</td>
<td align="left">Half tags (B type)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">3</td>
<td align="left">6 word half length tags</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">4</td>
<td align="left">X-ray binary ( tag_code_or_release_id must be ’XX0500’)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">5</td>
<td align="left">Standard color</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">6</td>
<td align="left">Solid color (—-)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">7</td>
<td align="left">Striped color ($$)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">8</td>
<td align="left">Rare Earth</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">9</td>
<td align="left">Repeating series</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">10</td>
<td align="left">Sequential 6 word binary;</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">11</td>
<td align="left">Length &amp; ½ Binary (1.5mm)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">12</td>
<td align="left">Standard Alphanumeric, includes Decimal (1 mm)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">13</td>
<td align="left">Length &amp; ½ Alphanumeric, includes Decimal (1.5 mm)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">14</td>
<td align="left">Sequential Alphanumeric, includes Decimal</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">15</td>
<td align="left">Half length Alphanumeric, includes Decimal (0.5mm)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">tag_type</td>
<td align="left">16</td>
<td align="left">Pseudo tag, blank wire</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">related_group_type</td>
<td align="left">D</td>
<td align="left">Double index tag groups</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">related_group_type</td>
<td align="left">O</td>
<td align="left">Other related groups</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">1</td>
<td align="left">Chinook</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">2</td>
<td align="left">Coho</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">3</td>
<td align="left">Steelhead</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">4</td>
<td align="left">Sockeye</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">5</td>
<td align="left">Chum</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">6</td>
<td align="left">Pink</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">7</td>
<td align="left">Masu</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">8</td>
<td align="left">Cutthroat</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">species</td>
<td align="left">9</td>
<td align="left">Atlantic Salmon</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">1</td>
<td align="left">Spring</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">2</td>
<td align="left">Summer</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">3</td>
<td align="left">Fall (includes type S Coho)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">4</td>
<td align="left">Winter</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">5</td>
<td align="left">Hybrid</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">6</td>
<td align="left">Landlocked</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">7</td>
<td align="left">Late Fall (includes type N Coho)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">run</td>
<td align="left">8</td>
<td align="left">Late Fall Upriver Bright Chinook</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">Z</td>
<td align="left">Zygote (eyed eggs)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">E</td>
<td align="left">Emergent fry</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">F</td>
<td align="left">Fed fry</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">G</td>
<td align="left">Fingerling</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">V</td>
<td align="left">Advanced fingerling</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">Y</td>
<td align="left">Yearling</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">P</td>
<td align="left">Pre-smolt</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">S</td>
<td align="left">Smolt</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">A</td>
<td align="left">Adult</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_stage</td>
<td align="left">M</td>
<td align="left">Multiple release stages</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">rearing_type</td>
<td align="left">H</td>
<td align="left">Hatchery reared fish (includes any wild fish reared in the hatchery)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">rearing_type</td>
<td align="left">W</td>
<td align="left">Wild fish</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">rearing_type</td>
<td align="left">M</td>
<td align="left">Mixed hatchery &amp; wild (downstream migrant or marine tagging)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">rearing_type</td>
<td align="left">U</td>
<td align="left">Unknown (unavailable from release agency)</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">E</td>
<td align="left">Experimental</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">P</td>
<td align="left">Production</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">B</td>
<td align="left">Both experimental and production</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">O</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">K</td>
<td align="left">PSC key indicator stocks</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_type</td>
<td align="left">I</td>
<td align="left">Other index streams</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_strategy</td>
<td align="left">FR</td>
<td align="left">Forced release</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_strategy</td>
<td align="left">MX</td>
<td align="left">Mixed release strategies</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">release_strategy</td>
<td align="left">VO</td>
<td align="left">Volitional release</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_integrity</td>
<td align="left">N</td>
<td align="left">Normal range expected</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_integrity</td>
<td align="left">D</td>
<td align="left">Fish destroyed; zero survival assumed</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">study_integrity</td>
<td align="left">W</td>
<td align="left">Warning flag for serious problems</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">B</td>
<td align="left">Book estimates</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">C</td>
<td align="left">Actual physical counts</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">P</td>
<td align="left">Petersen estimates</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">W</td>
<td align="left">Weight derived estimates</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">V</td>
<td align="left">Volumetric Conversion</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Release Data</td>
<td align="left">counting_method</td>
<td align="left">F</td>
<td align="left">Feed Conversion Estimates</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">record_code</td>
<td align="left">R</td>
<td align="left">Recovery record</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">1</td>
<td align="left">Chinook</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">2</td>
<td align="left">Coho</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">3</td>
<td align="left">Steelhead</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">4</td>
<td align="left">Sockeye</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">5</td>
<td align="left">Chum</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">6</td>
<td align="left">Pink</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">7</td>
<td align="left">Masu</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">8</td>
<td align="left">Cutthroat</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">species</td>
<td align="left">9</td>
<td align="left">Atlantic Salmon</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">recovery_date_type</td>
<td align="left">R</td>
<td align="left">Reported date</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">recovery_date_type</td>
<td align="left">C</td>
<td align="left">Calculated date</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">period_type</td>
<td align="left">1</td>
<td align="left">Escapement period (across years possible)</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">period_type</td>
<td align="left">2</td>
<td align="left">Bi-weekly (statistical 2 week)</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Recovery Data</td>
<td align="left">period_type</td>
<td align="left">3</td>
<td align="left">Semi-monthly (calendar)</td>
</tr>
</tbody>
</table>
<p><strong>Booyah!</strong> It looks great. (There are some issues though with location codes which are hierarchical and thus require special treatment.)</p>
<p>Of course, it would be better if we didn’t have to go through all this rigmarole to get there. But what can you do?</p>
<p>Note that the above format is tidy, and if we had any of the data bases loaded as data frames then it would be pretty straightforward to replace the codes with their values and keep them as factors.</p>

          <hr>
           <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'rep-res-course'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
        </div>
      </div>

            <div class="footer">
        <hr>
        <p>
          <small>
            Authored by Eric C. Anderson working as a Federal employee.  Content on this website is a government work in the public domain in the U.S. and under the CC0 1.0 internationally. Templates and plugins to build the site are modified from Hadley Wickham's <a href="https://github.com/hadley/adv-r/">Advanced R</a> website. Powered by <a href="http://jekyllrb.com/">jekyll</a>,
          <a href="http://yihui.name/knitr/">knitr</a>, and
          <a href="http://johnmacfarlane.net/pandoc/">pandoc</a>. Source
          available on <a href="https://github.com/eriqande/rep-res-course/">github</a>.
          </small>
        </p>
      </div>


    </div> <!-- /container -->

  <script src="//code.jquery.com/jquery.js"></script>
  <script src="http://eriqande.github.io/rep-res-web/www/bootstrap.min.js"></script>
  <script src="http://eriqande.github.io/rep-res-web/www/toc.js"></script>
  <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
  </body>
</html>

